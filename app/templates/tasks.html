{% extends "base.html" %}
{% block title %}–ú–æ–∏ –∑–∞–¥–∞—á–∏ ‚Äî PingMeBot{% endblock %}

{% block content %}
<section class="new-task">
    <h2>–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h2>
    <form action="/web/tasks/create" method="post" id="new-task-form">
        <div id="title-field">
            <input type="text" name="title" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?" required>
        </div>

        <div id="description-field">
            <textarea name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
        </div>

        <div id="deadline-field">
            <label>
                –î–µ–¥–ª–∞–π–Ω:
                <input type="datetime-local" name="due_at" id="due-at-input">
            </label>
        </div>

        <div id="reminders-field">
            <p>–ù–∞–ø–æ–º–Ω–∏—Ç—å:</p>
            <label>
                <input type="checkbox" name="remind_presets" value="3d" class="preset-checkbox">
                –∑–∞ 3 –¥–Ω—è
            </label>
            <label>
                <input type="checkbox" name="remind_presets" value="1d" class="preset-checkbox">
                –∑–∞ –¥–µ–Ω—å
            </label>
            <label>
                <input type="checkbox" name="remind_presets" value="12h" class="preset-checkbox">
                –∑–∞ 12 —á–∞—Å–æ–≤
            </label>
            <label>
                <input type="checkbox" name="remind_presets" value="1h" class="preset-checkbox">
                –∑–∞ —á–∞—Å
            </label>

            <label>
                –°–≤–æ–µ –≤—Ä–µ–º—è:
                <input type="datetime-local" name="custom_remind_at" id="custom-remind-input">
            </label>
        </div>

        <div class="toggles">
            <label>
                <input type="checkbox" id="no-description-toggle">
                –ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è
            </label>
            <label>
                <input type="checkbox" id="no-deadline-toggle">
                –ù–µ—Ç –¥–µ–¥–ª–∞–π–Ω–∞
            </label>
            <label>
                <input type="checkbox" id="no-reminders-toggle">
                –ù–µ –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å
            </label>
        </div>

        <button type="submit" class="pretty-buttons">–î–æ–±–∞–≤–∏—Ç—å</button>
    </form>
</section>


<section class="task-columns">
    <div class="column">
        <h2>–ù–æ–≤—ã–µ</h2>
        {% if tasks_pending %}
        <ul>
            {% for task in tasks_pending %}
            <li class="task-card">
                <a href="/web/tasks/{{ task.id }}/edit"
                   class="edit-btn"
                   title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É">
                    ‚úé
                </a>

                <form
                        action="/web/tasks/{{ task.id }}/delete"
                        method="post"
                        class="delete-form"
                        onsubmit="return confirm('–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –µ—â—ë –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é –∑–∞–¥–∞—á—É?');"
                >
                    <button type="submit" class="delete-btn" title="–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É">
                        ‚úï
                    </button>
                </form>

                <strong>{{ task.title }}</strong>
                {% if task.description %}
                <div class="desc">{{ task.description }}</div>
                {% endif %}
                {% if task.due_at %}
                <div class="meta {% if task.due_at < now %}overdue{% endif %}">
                    –î–µ–¥–ª–∞–π–Ω: {{ task.due_at.strftime('%d.%m.%Y %H:%M') }}
                </div>
                {% endif %}

                {% if task.remind_at %}
                <div class="meta reminder">
                    üîî –ë–ª–∏–∂–∞–π—à–µ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: {{ task.remind_at.strftime('%d.%m.%Y %H:%M') }}
                </div>
                {% endif %}
                <form action="/web/tasks/{{ task.id }}/start" method="post" style="display:inline">
                    <button class="pretty-buttons" type="submit">–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>
                </form>
                <form action="/web/tasks/{{ task.id }}/done" method="post" style="display:inline">
                    <button class="pretty-buttons" type="submit">–°–¥–µ–ª–∞–Ω–æ</button>
                </form>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p>–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á.</p>
        {% endif %}
    </div>


    <div class="column">
        <h2>–í —Ä–∞–±–æ—Ç–µ</h2>
        {% if tasks_in_progress %}
        <ul>
            {% for task in tasks_in_progress %}
            <li class="task-card">
                <a href="/web/tasks/{{ task.id }}/edit"
                   class="edit-btn"
                   title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É">
                    ‚úé
                </a>

                <form
                        action="/web/tasks/{{ task.id }}/delete"
                        method="post"
                        class="delete-form"
                        onsubmit="return confirm('–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –µ—â—ë –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é –∑–∞–¥–∞—á—É?');"
                >
                    <button type="submit" class="delete-btn" title="–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É">
                        ‚úï
                    </button>
                </form>

                <strong>{{ task.title }}</strong>
                {% if task.description %}
                <div class="desc">{{ task.description }}</div>
                {% endif %}
                {% if task.due_at %}
                <div class="meta {% if task.due_at < now %}overdue{% endif %}">
                    –î–µ–¥–ª–∞–π–Ω: {{ task.due_at.strftime('%d.%m.%Y %H:%M') }}
                </div>
                {% endif %}

                {% if task.remind_at %}
                <div class="meta reminder">
                    üîî –ù–∞–ø–æ–º–Ω–∏—Ç—å: {{ task.remind_at.strftime('%d.%m.%Y %H:%M') }}
                </div>
                {% endif %}
                <form action="/web/tasks/{{ task.id }}/done" method="post" style="display:inline">
                    <button class="pretty-buttons" type="submit">–°–¥–µ–ª–∞–Ω–æ</button>
                </form>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p>–ù–µ—Ç –∑–∞–¥–∞—á –≤ —Ä–∞–±–æ—Ç–µ.</p>
        {% endif %}
    </div>


    <div class="column">
        <h2>–ì–æ—Ç–æ–≤–æ</h2>
        {% if tasks_done %}
        <ul>
            {% for task in tasks_done %}
            <li class="task-card">
                <a href="/web/tasks/{{ task.id }}/edit"
                   class="edit-btn"
                   title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É">
                    ‚úé
                </a>

                <form
                        action="/web/tasks/{{ task.id }}/delete"
                        method="post"
                        class="delete-form"
                >
                    <button type="submit" class="delete-btn" title="–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É">
                        ‚úï
                    </button>
                </form>

                <strong>{{ task.title }}</strong>
                {% if task.description %}
                <div class="desc">{{ task.description }}</div>
                {% endif %}
                {% if task.due_at %}
                <div class="meta {% if task.due_at < now %}overdue{% endif %}">
                    –î–µ–¥–ª–∞–π–Ω: {{ task.due_at.strftime('%d.%m.%Y %H:%M') }}
                </div>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p>–ì–æ—Ç–æ–≤—ã—Ö –∑–∞–¥–∞—á –ø–æ–∫–∞ –Ω–µ—Ç.</p>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const descToggle = document.getElementById("no-description-toggle");
        const descField = document.getElementById("description-field");
        const descTextarea = descField?.querySelector("textarea[name='description']");

        const deadlineToggle = document.getElementById("no-deadline-toggle");
        const deadlineField = document.getElementById("deadline-field");
        const dueInput = document.getElementById("due-at-input");

        const remindersToggle = document.getElementById("no-reminders-toggle");
        const remindersField = document.getElementById("reminders-field");
        const presetCheckboxes = document.querySelectorAll(".preset-checkbox");
        const customRemindInput = document.getElementById("custom-remind-input");


        if (descToggle && descField && descTextarea) {
            descToggle.addEventListener("change", () => {
                if (descToggle.checked) {
                    descField.style.display = "none";
                    descTextarea.value = "";
                } else {
                    descField.style.display = "";
                }
            });
        }

        if (deadlineToggle && deadlineField && dueInput) {
            const updateDeadlineState = () => {
                if (deadlineToggle.checked) {
                    deadlineField.style.display = "none";
                    dueInput.value = "";
                } else {
                    deadlineField.style.display = "";
                }
                // –ø—Ä–µ—Å–µ—Ç—ã –∑–∞–≤–∏—Å—è—Ç –æ—Ç –¥–µ–¥–ª–∞–π–Ω–∞: –µ—Å–ª–∏ –Ω–µ—Ç –¥–µ–¥–ª–∞–π–Ω–∞ ‚Äî –æ—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ—Å–µ—Ç—ã
                const hasDeadline = !deadlineToggle.checked && !!dueInput.value;
                presetCheckboxes.forEach(cb => {
                    cb.disabled = !hasDeadline;
                    if (!hasDeadline) cb.checked = false;
                });
            };

            deadlineToggle.addEventListener("change", updateDeadlineState);
            dueInput.addEventListener("input", updateDeadlineState);
            updateDeadlineState();
        }


        if (remindersToggle && remindersField) {
            remindersToggle.addEventListener("change", () => {
                if (remindersToggle.checked) {
                    remindersField.style.display = "none";
                    presetCheckboxes.forEach(cb => cb.checked = false);
                    if (customRemindInput) customRemindInput.value = "";
                } else {
                    remindersField.style.display = "";
                }
            });
        }
    });
</script>
{% endblock %}
